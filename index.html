<!DOCTYPE html>
<meta charset="utf-8">
<title>Socialdata by kristiangreve</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
<head>
<style>

body {
  font: 12px sans-serif;
  background-color: #fff;
}

.container {
    width: 1080px;
    margin: 40px auto 0 auto;
    padding: 60px;
    background-color: #fff;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.hozlabel path,
.hozlabel line {
    display: none;
}

.bar {
  fill: steelblue;
}

.x.axis path {
  display: none;
}
p#g10k, p#g100k {
    background-color: #4682b4;
}

p#male.selected, p#female.selected,p#g10k.selected,p#g100k.selected {
    border: 1px solid rgb(100,100,200);
    font-weight: bold;
    background-color: #fff;
    color: rgb(100,100,200);
    box-shadow: 0 0 5px rgba(0,0,255,0.2);
}

p#male, p#female, p#g10k, p#g100k {
    display: inline;
    text-transform: uppercase;
    border: 1px solid #333;
    color: #fff;
    padding: 10px 20px;
    border-radius: 10px;
    margin: 10px;
    cursor: pointer;
}

p#male {
    background-color: rgb(138, 137, 166);
}

p#female {
    background-color: rgb(152, 171, 197);
}

/* magnifying glass icon */
.zoom {
      display:inline-block;
      position: relative;
      border: 1px solid rgb(100,100,200);
}
.zoom:after {
  content:'';
  display:block; 
  width:33px; 
  height:33px; 
  position:absolute; 
  top:0;
  right:0;
  background:url(img/icon.png);
}

.zoom img {
  display: block;
}

.zoom img::selection { background-color: transparent; }

#ex2 img:hover { cursor: url(grab.cur), default; }
#ex2 img:active { cursor: url(grabbed.cur), default; }

#g100kgraph.hidden, #g10kgraph.hidden {
    display: none;
}

.province {
    stroke: #fff;
    stroke-width: 1px;
}
.kommune {
    stroke: #fff;
    stroke-width: 1px;
}

.hidden {
    display: none;
}

div.tooltip {
    color: #222;
    background-color: #fff;
    padding: .5em;
    text-shadow: #f5f5f5 0 1px 0;
    border-radius: 2px;
    opacity: 0.9;
    position: absolute;
}

.legend {
    font-size: 12px;
}

</style>
<script src='http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js'></script>
<script src='js/jquery.zoom.min.js'></script>
<script>
  $(document).ready(function(){
    $('#g100kgraph').zoom();
    $('#g10kgraph').zoom();
    $('#ex2').zoom({ on:'grab' });
    $('#ex3').zoom({ on:'click' });      
    $('#ex4').zoom({ on:'toggle' });
  });
</script>
</head>
<body>

    <section class="page-header">
      <h1 class="project-name">Socialdata</h1>
      <h2 class="project-tagline"></h2>
      <a href="https://github.com/kristiangreve/socialdata" class="btn">View on GitHub</a>
      <a href="https://github.com/kristiangreve/socialdata/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/kristiangreve/socialdata/tarball/master" class="btn">Download .tar.gz</a>
    </section>
<br>
    <br>


    <section class="main-content">
        
    <h1>Introduction</h1>
    <p> Whoever you were before visiting this page, you’re now a librarian.
    Over the next couple of minutes you are going to know a whole lot more about books in the kingdom of Denmark.
    We took loaner data from the years 2009-2016 and made accessible to you through various visualizations.
    Excited? You should be! Sit back and relax a guided tour through the data. </p>

    

    <h2>Top books by gender (ratio)</h2>
    <p>First off, let’s have a look at what books men and women bring home the most from the danish libraries. Some prejudices about gender seem to be true: Females are more into books about diets, while males like to read about stamps. They also seem to be pretty insecure about their masculinity and borrow DIY books. Take some time to explore the data and you will find that the travel books from Politiken, “Turen går til..” are pretty popular among both genders. You should probably put them somewhere that’s not too embarrassing to go for either men or women.</p>

    <br>
    <br>

    <p id="female"> Top 25 female book loans </p>
    <p id="male"> Top 25 male book loans </p>
    <br>
    <br>
    <div id="top25"></div>
    <br>
    <br>

    <h2>Ages of book readers</h2>

    <p>Interests change over time, and as a librarian you should take this into account when buying or arranging your books. Why not make a nice senior section? The difference between what people of different ages read is particularly noticeable in books such as “Den Gode Opgave” and “Jesus, Pengene og Livet.” The former (a study book) is mostly read by younger audiences, while the latter (a biography) have a much older audience. Also notice the very young readers (less than 5 years) loaning heavy books such as Zornig's biography depicting her awful childhood. What’s up with that? This could be interpreted as either bad data or people using their child's loaner card to be allowed to keep their book a bit longer.</p>
    <br>
    <br>

    Choose book (top 10 female loans) <select name="" id="book">
        <option value="0">Zornig - vrede er mit mellemnavn</option>
        <option value="1">Den gode opgave</option>
        <option value="2">Sværkeslægten</option>
        <option value="3">Turen går til London</option>
        <option value="4">Vi kan sove i flyvemaskinen</option>
        <option value="5">Turen går til Hamburg og Nordtyskland</option>
        <option value="6">3096 dage</option>
        <option value="7">Turen går til Berlin</option>
        <option value="8">Jesus, pengene og livet</option>
        <option value="9">Turen går til Tyrkiet</option>
    </select>
    <br>
    <br>
    <div id="top10"></div>
    <br>
    <br>
    <h2>Book loans during the year (top 10 loans in 2014)</h2>

    <p>Again, we see a clear trend in loans of the study book Den Gode Opgave, which seems to drop drastically during the summer vacation and grow again once the fall semester begins. Maybe you should put this book somewhere that those youngsters will pass some real important literature? Other books such as th diet book “5:2 Kuren” has its peak at summertime where people feel like getting beach ready. Have a look at it yourself using the drop down menu.</p>
<br>
    <br>
    <select name="" id="year">
        <option value="0">Så skal der leves!</option>
        <option value="1">Forfulgt</option>
        <option value="2">Den gode opgave</option>
        <option value="3">Den hemmelige socialdemokrat</option>
        <option value="4">Ikke et sekund spildt</option>
        <option value="5">Turen går til Hamburg og Nordtyskland</option>
        <option value="6">Jesus, pengene og livet</option>
        <option value="7">5:2 kuren</option>
        <option value="8">Turen går til London</option>
        <option value="9">Zornig - vrede er mit mellemnavn</option>
    </select>
    <br>
    <br>
    <div id="book_by_month"></div>
    <br>
    <br>
    <h2>Books and municipals (percentage of loaned books)</h2>
    <p>Just like gender and age are influencing what books people are loaning, geography has an infuence on which categories are most popular. If data is featured from your municipal, try hovering the mouse over it to see the exact percentage of loans that belong to the chosen category. Change the category in the drop-down menu. Have a look at "Praktiske fag", the overall most popular category out of the ten existing dk5 categories. It's especially popular in "Varde" with a 34,5% share of the total loans. In Gentofte that number is 23%. If you're from Gentofte and stuck with a bunch of books on "Praktisk fag" you might want to ship them to your nice colleage on the west coast. Browse the categories and see how you municipal is doing compared to the others.
    </p>
    <br>
    <br>

      <select id="select_popularbooks" style="text-align:center;">
          <option value="kommuneratio/Filosofi.csv">Filosofi, psykologi, videnskab og forskning</option>
          <option value="kommuneratio/KristneReligion.csv">Religion</option>
          <option value="kommuneratio/Haandvaerk.csv">Blandet indhold</option>
          <option value="kommuneratio/LitteraturteoriOgLitteraturforskning.csv">Litteratur og sprog</option>
          <option value="kommuneratio/Teknik.csv">Praktiske fag</option>
          <option value="kommuneratio/Kunst.csv">Kunst, spil og sport</option>
          <option value="kommuneratio/Samvidenskaberne.csv">Samfundsvidenskab</option>
          <option value="kommuneratio/GeografiOgRejser.csv">Geografi og rejser</option>
          <option value="kommuneratio/Naturvidenskab.csv">Naturvidenskab og matematik</option>
          <option value="kommuneratio/Historie.csv">Historie og biografier</option>
    </select>
    <br>
    <br>
    <div id="map_popularbooks" style="text-align:center;"></div>
    <br>
    <br>

    <h2>K nearest neighbors (KNN)</h2>
    <p> We know what you're thinking: "Where the hell is my municipal? I'm lost". And we're so sorry. The thing is, out of the 99 municipals in Denmark, we've only been provided with data on 49 of them. But fear not, we have a way to let you find out what category is the most popular in your area anyway. Using KNN, we're looking at a grid of points on top of Denmark, and deciding for each point what category is most fitted for that one. We're looking at 50, 100, 200 and 300 nearnest neighbors respecitvely. It turns out that the above mentioned category "Praktiske fag" is indeed the most popular, and it kind of ruins it for all the other nice categories. So if you want to see what category is the bees knees in your community try choosing the "without "Praktiske fag"" options on the drop-down menu.
    </p>
    <br>
    <p> 
    For "K=200, without "Praktiske fag"", if you're a librarian in Aalborg you might want to focus your library on "Samfundsvidenskab" while all the others read their stupid "Historie og biografier". And if you increase the number of neighbors that are taken into account, you're still on the right path if you bet on "Praktiske fag". Try not to worry about the colored water, nobody's drowning.
    </p>
    <br>
    <br>
    <select id="select_knn" style="text-align:center;">
          <option value="knn/knn50.csv">K = 50</option>
          <option value="knn/knn100.csv">K = 100</option>
          <option value="knn/knn200.csv">K = 200</option>
          <option value="knn/knn300.csv">K = 300</option>
          <option value="knn/knn50_edited.csv" >K = 50,without "Praktiske fag"</option>
          <option value="knn/knn100_edited.csv">K = 100,without "Praktiske fag"</option>
          <option value="knn/knn200_edited.csv">K = 200,without "Praktiske fag"</option>
          <option value="knn/knn300_edited.csv">K = 300,without "Praktiske fag"</option>
    </select>
    <br>
    <br>
    <div id="map_knn" style="text-align:center;"></div>

    <br>
    <br>

    <h2>Association rules</h2>
    <p>Ok, guess your coffee break has come to an end, and now you just want the quick and dirty insights? Alright, you earned it. We used something called association mining search the loan data for association rules. An association rule is a rule that says:</p>
    <br>
    <p><i>"If you loaned book a, you're going to loan book b with x amount of certanty"</i></p>
    <br>
    <p> Specifically, associations between book loans were mined using the <a href="http://aimotion.blogspot.dk/2013/01/machine-learning-and-data-mining.html" target="_blank">Apriori algorithm</a>. 

    The following graph networks shows which titles are connected. Firstly, the data was limited to non-fiction litterature, given the amount of meta-data available for these titles (genre was not availble for titles of fiction). Secondly, the loaner data was transformed into a list of loans for each individual loaner in Denmark (more than 1 mio. loaners).
    This way, the data could be viewed as a list of transactions, were each loan would represent a transaction item.
    Then, the Apriori algorithm was used on loaner data from first 10.000 loaners and then 100.000 loaners. To be able to find the rules of interest for most people, the titles were limited to itemsets with at least 0.5% support (meaning that only titles that were loaned 0.5% or more of the times were considered to be of interest).
    Furthermore, the rules were filtered by their confidence, meaning the probability that consequent would occur given the knowledge that the antecedent occuring. The confidence threshold was set at 30% for the 10k sample and 10% for the 100k sample (smaller samples will have more rules with high confidence due to samples biases).
    The graph networks shows associations (represented as edges) between titles (represented as nodes) with confidence as edge labels.</p>
    <br>
    <br>
    <p id="g10k" class="selected"> Rules for 10k loaners </p>
    <p id="g100k"> Rules for 100k loaners </p>
  <span class='zoom' id='g10kgraph'>
      <img src="img/graphs-2.png" width="960" height="auto"></img>
  </span>
  <span class='zoom hidden' id='g100kgraph'>
    <img src="img/graphs.png" width="960" height="auto"></img>
  </span>
  <br>
  <br>
  <p> Dive into the data on the picture. You're going to see that titles such as "Vi kan sove i flyvemaskinen" and "Jesus, pengene og livet" are the one to stock up on if you want your guests to have something to return for. No matter what else your guests loan, Ulla Therkelsen is a safe bet. Interesting!</p>



  <h2>Sorting association pairs by confidence</h2>
  <p>The rules can be sorted by confidence to explore the most strongly connected associations. The figure below clearly shows how this type of data mining can be used to create a recommendation system that could be implemented on library websites or used to place titles physically near each other.

  The diagram should be read as: Having loaned the title on the left makes a person likely to loan the title on the right with a confidence shown between the two. For example, the rule with the highest confidence is 'Norge' -> 'Turen går til Norge' (0.714), meaning that 71,4% of the people that loaned the title 'Norge' also loaned 'Turen går til Norge'.
  It is quite easy to validate that the algorithm functioned as intended by scanning through the top title associations.</p>
  <br>
  <br>
  <div id="rules"></div>


<h2>Thank you</h2>
  <p>Thanks for stopping by! Hopefully you're a whole lot wiser than when you tuned in. You've learned how age, geography and gender have influence on what books people loan and that there are in fact patterns in what they loan. There's no more excuses for not looking at what people want before buying new books  (Psst 1.1 mio titles were never loaned in the years we looked at. We know you can do better.)</p>



</section>

<script type="text/javascript" src="d3/d3.min.js"></script>
<script src="d3/colorbrewer.js" type="text/javascript"></script>

<script>


var margin = {top: 20, right: 20, bottom: 60, left: 60},
    width = 960 - margin.left - margin.right,
    height = 560 - margin.top - margin.bottom;

var color = d3.scale.ordinal()
    .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b"]);

function buildBar(dataset) {
    var genderNames = d3.keys(dataset[0]).filter(function(key) { return (key !== "title") && (key !== 'female_count') && (key !== 'male_count') ; });
    
      dataset.forEach(function(d) {
        d.gender = genderNames.map(function(name) { 
          return {name: name, value: +d[name]}; });
      });

    var x0 = d3.scale.ordinal()
        .rangeRoundBands([0, width], .1);
    
    var x1 = d3.scale.ordinal();
    
    var y = d3.scale.linear()
        .range([height, 0]);    
        
    x0.domain(dataset.map(function(d) { return d.title; }));
    x1.domain(genderNames).rangeRoundBands([0, x0.rangeBand()]);
    y.domain([0, d3.max(dataset, function(d) { return d3.max(d.gender, function(d) { return d.value; }); })]);
        
    var xAxis = d3.svg.axis()
        .scale(x0)
        .orient("bottom");
    
    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left");
        //.tickFormat(d3.format(".2s"));
    
    var svg = d3.select("#top25").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom + 240)
      .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
        

  svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis)
      .selectAll("text")  
            .style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", ".15em")
            .attr("text-overflow", "ellipsis")
            .attr("transform", function(d) {
                return "rotate(-65)" 
                });

  svg.append("g")
      .attr("class", "y axis")
      .call(yAxis)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", -60)
      .attr("x", -150)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("Ratio of Loans / No. of loans");

  var title = svg.selectAll(".title")
      .data(dataset)
    .enter().append("g")
      .attr("class", "title")
      .attr("transform", function(d) { return "translate(" + x0(d.title) + ",0)"; });

  title.selectAll("rect")
      .data(function(d) { return d.gender; })
        .enter().append("rect")
      //.attr("width", x1.rangeBand())
      .attr("width", 10)
      .attr("x", function(d) { return x1(d.name); })
      .attr("y", function(d) { return y(d.value); })
      .attr("height", function(d) { return height - y(d.value); })
      .style("fill", function(d) { return color(d.name); });

  var legend = svg.selectAll(".legend")
      .data(genderNames.slice().reverse())
    .enter().append("g")
      .attr("class", "legend")
      .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

  legend.append("rect")
      .attr("x", width - 18)
      .attr("width", 18)
      .attr("height", 18)
      .style("fill", color);

  legend.append("text")
      .attr("x", width - 24)
      .attr("y", 9)
      .attr("dy", ".35em")
      .style("text-anchor", "end")
      .text(function(d) { return d; });
}

function updateBar(temp_data){

    var genderNames = d3.keys(temp_data[0]).filter(function(key) { return (key !== "title") && (key !== 'female_count') && (key !== 'male_count') ; });
    
    temp_data.forEach(function(d) {
        d.gender = genderNames.map(function(name) { 
           return {name: name, value: +d[name]}; });
    });
    
    
    var x0 = d3.scale.ordinal()
    .rangeRoundBands([0, width], .1);
    
    var x1 = d3.scale.ordinal();
    
    var y = d3.scale.linear()
        .range([height, 0]);  

    x0.domain(temp_data.map(function(d) { return d.title; }));
    x1.domain(genderNames).rangeRoundBands([0, x0.rangeBand()]);
    y.domain([0, d3.max(temp_data, function(d) { return d3.max(d.gender, function(d) { return d.value; }); })]);

    var xAxis = d3.svg.axis()
        .scale(x0)
        .orient("bottom");
    
    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left");
        //.tickFormat(d3.format(".2s"));
    
    var svg = d3.select("#top25").select("svg");
    
    svg.selectAll(".x.axis")
      .call(xAxis)
      .selectAll("text")  
            .style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", ".15em")
            .attr("text-overflow", "ellipsis")
            .attr("transform", function(d) {
                return "rotate(-65)" 
                });
    
    var title = svg.selectAll(".title")
        .data(temp_data)
    
    title.selectAll("rect")
        .data(function(d) { return d.gender; })
        .transition()
        .duration(2000)
        //.attr("width", x1.rangeBand())
        .attr("width", 10)
        .attr("x", function(d) { return x1(d.name); })
        .attr("y", function(d) { return y(d.value); })
        .attr("height", function(d) { return height - y(d.value); })
        .style("fill", function(d) { return color(d.name); });    
}

function buildAgeBar(dataset) {
    var genderNames = d3.keys(dataset[0]).filter(function(key) { return (key == "0") ; });
    
      dataset.forEach(function(d) {
        d.gender = genderNames.map(function(name) { 
          return {name: name, value: +d[name]}; });
      });

    var x0 = d3.scale.ordinal()
        .rangeRoundBands([0, width], .1);
    
    var x1 = d3.scale.ordinal();
    
    var y = d3.scale.linear()
        .range([height, 0]);    
        
    x0.domain(dataset.map(function(d) { return d.age; }));
    //x0.domain([0,50,101]);
    x1.domain(genderNames).rangeRoundBands([0, x0.rangeBand()]);
    y.domain([0, 1110]);
    //y.domain([0, d3.max(dataset, function(d) { return d3.max(d.gender, function(d) { return d.value; }); })]);

    var formatxAxis = d3.format('.0f');
    
    var xAxis = d3.svg.axis()
        .scale(x0)
        //.scale(d3.range(0, 101, 10))
        //.tickValues(d3.range(0, 101, 10))
        .ticks(100)
        .tickFormat(formatxAxis)
        .orient("bottom");
    
    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left")
        .tickFormat(d3.format(".2s"));
    
    var svg = d3.select("#top10").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
        

  svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis)
      .selectAll("text")  
            .style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", ".15em")
            .attr("text-overflow", "ellipsis")
            .attr("font-size", "8px")
            .attr("transform", function(d) {
                return "rotate(-65)" 
                });

  svg.append("g")
      .attr("class", "y axis")
      .call(yAxis)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", -50)
      .attr("x", -150)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("Number of book loans");

  var title = svg.selectAll(".title")
      .data(dataset)
    .enter().append("g")
      .attr("class", "title")
      .attr("transform", function(d) { return "translate(" + x0(d.age) + ",0)"; });

  title.selectAll("rect")
      .data(function(d) { return d.gender; })
        .enter().append("rect")
      .attr("width", x1.rangeBand())
      .attr("x", function(d) { return x1(d.name); })
      .attr("y", function(d) { return y(d.value); })
      .attr("height", function(d) { return height - y(d.value); })
      .style("fill", function(d) { return color(d.name); });

}

function updateAgeBar(temp_data, col){

    var genderNames = d3.keys(temp_data[0]).filter(function(key) { return (key == col) ; });
    
    temp_data.forEach(function(d) {
        d.gender = genderNames.map(function(name) { 
           return {name: name, value: +d[name]}; });
    });
    
    
    var x0 = d3.scale.ordinal()
    .rangeRoundBands([0, width], .1);
    
    var x1 = d3.scale.ordinal();
    
    var y = d3.scale.linear()
        .range([height, 0]);  

    x0.domain(temp_data.map(function(d) { return d.age; }));
    x1.domain(genderNames).rangeRoundBands([0, x0.rangeBand()]);
    y.domain([0, 1110]);
    
    var formatxAxis = d3.format('.0f');
    
    var xAxis = d3.svg.axis()
        .scale(x0)
        .tickFormat(formatxAxis)
        .orient("bottom");
    
    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left")
        .tickFormat(d3.format(".2s"));
    
    var svg = d3.select("#top10").select("svg");
    
    svg.selectAll(".x.axis")
      .call(xAxis)
      .selectAll("text")  
            .style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", ".15em")
            .attr("text-overflow", "ellipsis")
            .attr("transform", function(d) {
                return "rotate(-65)" 
                });
    
    var title = svg.selectAll(".title")
        .data(temp_data)
    
    title.selectAll("rect")
        .data(function(d) { return d.gender; })
        .transition()
        .duration(2000)
        .attr("width", x1.rangeBand())
        .attr("x", function(d) { return x1(d.name); })
        .attr("y", function(d) { return y(d.value); })
        .attr("height", function(d) { return height - y(d.value); })
        .style("fill", function(d) { return color(d.name); });    
}

function buildMonthBar(dataset) {
    var genderNames = d3.keys(dataset[0]).filter(function(key) { return (key == "0") ; });
    
      dataset.forEach(function(d) {
        d.gender = genderNames.map(function(name) { 
          return {name: name, value: +d[name]}; });
      });

    var x0 = d3.scale.ordinal()
        .rangeRoundBands([0, width], .1);
    
    var x1 = d3.scale.ordinal();
    
    var y = d3.scale.linear()
        .range([height, 0]);    
        
    x0.domain(dataset.map(function(d) { return d.month; }));
    x1.domain(genderNames).rangeRoundBands([0, x0.rangeBand()]);
    y.domain([0, 600]);
    //y.domain([0, d3.max(dataset, function(d) { return d3.max(d.gender, function(d) { return d.value; }); })]);
    
    var xAxis = d3.svg.axis()
        .scale(x0)
        //.scale(d3.range(0, 101, 10))
        //.tickValues(d3.range(0, 101, 10))
        //.ticks(5)
        .orient("bottom");
    
    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left")
        .tickFormat(d3.format(".2s"));
    
    var svg = d3.select("#book_by_month").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
        

  svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis)
      .selectAll("text")  
            .style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", ".15em")
            .attr("text-overflow", "ellipsis")
            .attr("transform", function(d) {
                return "rotate(-65)" 
                });

  svg.append("g")
      .attr("class", "y axis")
      .call(yAxis)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", -50)
      .attr("x", -150)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("Number of book loans");

  var title = svg.selectAll(".title")
      .data(dataset)
    .enter().append("g")
      .attr("class", "title")
      .attr("transform", function(d) { return "translate(" + x0(d.month) + ",0)"; });

  title.selectAll("rect")
      .data(function(d) { return d.gender; })
        .enter().append("rect")
      .attr("width", x1.rangeBand())
      .attr("x", function(d) { return x1(d.name); })
      .attr("y", function(d) { return y(d.value); })
      .attr("height", function(d) { return height - y(d.value); })
      .style("fill", function(d) { return color(d.name); });

}

function updateMonthBar(temp_data, col){

    var genderNames = d3.keys(temp_data[0]).filter(function(key) { return (key == col) ; });
    
    temp_data.forEach(function(d) {
        d.gender = genderNames.map(function(name) { 
           return {name: name, value: +d[name]}; });
    });
    
    
    var x0 = d3.scale.ordinal()
    .rangeRoundBands([0, width], .1);
    
    var x1 = d3.scale.ordinal();
    
    var y = d3.scale.linear()
        .range([height, 0]);  

    x0.domain(temp_data.map(function(d) { return d.month; }));
    x1.domain(genderNames).rangeRoundBands([0, x0.rangeBand()]);
    y.domain([0, 600]);
    
    
    var xAxis = d3.svg.axis()
        .scale(x0)
        .orient("bottom");
    
    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left")
        .tickFormat(d3.format(".2s"));
    
    var svg = d3.select("#book_by_month").select("svg");
    
    svg.selectAll(".x.axis")
      .call(xAxis)
      .selectAll("text")  
            .style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", ".15em")
            .attr("text-overflow", "ellipsis")
            .attr("transform", function(d) {
                return "rotate(-65)" 
                });
    
    var title = svg.selectAll(".title")
        .data(temp_data)
    
    title.selectAll("rect")
        .data(function(d) { return d.gender; })
        .transition()
        .duration(2000)
        .attr("width", x1.rangeBand())
        .attr("x", function(d) { return x1(d.name); })
        .attr("y", function(d) { return y(d.value); })
        .attr("height", function(d) { return height - y(d.value); })
        .style("fill", function(d) { return color(d.name); });    
}

function buildRulesBar(dataset) {
    var genderNames = d3.keys(dataset[0]).filter(function(key) { return (key == "confidence") ; });
    
      dataset.forEach(function(d) {
        d.gender = genderNames.map(function(name) { 
          return {name: name, value: +d[name]}; });
      });
    var indices = d3.range(0, dataset.length);
    var x0 = d3.scale.ordinal()
        .domain(indices)
        .rangeRoundBands([0, width], .1);
    
    var x1 = d3.scale.ordinal()
        .domain(indices)
        .rangeRoundBands([0, width], .1);
    
    var y = d3.scale.linear()
        .domain(indices)
        .range([height, 0]);    
        
    x0.domain(dataset.map(function(d) { return d.antetitle; }));
    x1.domain(dataset.map(function(d) { return d.constitle; }));
    y.domain([0, 1]);
    //y.domain([0, d3.max(dataset, function(d) { return d3.max(d.gender, function(d) { return d.value; }); })]);
    
    var xAxis = d3.svg.axis()
        //.scale(x0)
        .scale(x0)
        //.scale(d3.range(0, 101, 10))
        //.tickValues(d3.range(0, 101, 10))
        //.ticks(5)
        .tickSize(-width/2+100)
        .tickSubdivide(true)
        .orient("bottom");
        
    var xLabel = d3.svg.axis()
        .scale(x1)
        //.scale(d3.range(0, 101, 10))
        //.tickValues(d3.range(0, 101, 10))
        //.ticks(5)
        .orient("bottom");
    
    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left")
        //.tickFormat(d3.format(".2s"));
    
    var svg = d3.select("#rules").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height * 2)
      .append("g")
        .attr("transform", "rotate(90) translate(" + margin.left + "," + -850 + ")");
        

  svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis)
      .selectAll("text")  
            .style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", ".15em")
            .attr("text-overflow", "ellipsis")
            .attr("transform", function(d) {
                return "rotate(-90)" 
                });
                
    svg.append("g")
      .attr("class", "hozlabel")
      .attr("transform", "translate(0,120)")
      .call(xLabel)
      .selectAll("text")  
            .style("text-anchor", "start")
            .attr("dx", "-.8em")
            .attr("dy", ".15em")
            .attr("text-overflow", "ellipsis")
            .attr("transform", "rotate(-90) translate(0,-8)");
  
    svg.append("g")
      .attr("class", "y axis")
      .call(yAxis)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", -50)
      .attr("x", -300)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("Confidence")
      .attr("font-weight", "bold");

  var title = svg.selectAll(".title")
      .data(dataset)
    .enter().append("g")
      .attr("class", "title")
      .attr("transform", function(d) { return "translate(" + x0(d.antetitle) + ",0)"; });

  title.selectAll("rect")
      .data(function(d) { return d.gender; })
        .enter().append("rect")
      .attr("width", x1.rangeBand() / 2)
      .attr("x", function(d) { return x1(d.name); })
      //.attr("x", function(d,i) {return i * x1.rangeBand(); })
      .attr("y", function(d) { return y(d.value); })
      .attr("height", function(d) { return height - y(d.value); })
      .attr("transform", "translate(5,0)")
      .style("fill", function(d) { return "rgb(" + Math.round(d.value*255) + ",80," + (255 - Math.round(d.value*255/2)) + ")"; });
      

}
        

function updateData(filename) {

          var width = 600,
            height = 800,
            center = [11.9, 56.7]
            scale = 7000,
            opacity = 1;
        var projection = d3.geo.mercator().scale(scale).center(center);
        var path = d3.geo.path().projection(projection);
        var svg = d3.select("#map_popularbooks").select("svg");

        var color = d3.scale.quantize().range(colorbrewer.Greens[9]);
d3.csv(filename, function(data) {

    var tooltip = d3.select('#map_popularbooks').append('div').attr('class', 'hidden tooltip');
    var min = d3.min(data, function(d) {
        return d.kommunenummer;
    }) * 100;
    var max = d3.max(data, function(d) {
        return d.kommunenummer;
    }) * 100;
    color.domain([min,max]);
    var step = (max - min) / 10;
    var color_domain = range(min, max, step);
    var ext_color_domain = range(min, max, step);
    var interval = (color_domain[2] - color_domain[1]) / 2
    var border1 = (color_domain[0]);
    var border2 = (color_domain[0] + interval);
    var border3 = (color_domain[1] + interval);
    var border4 = (color_domain[2] + interval);
    var border5 = (color_domain[3] + interval);
    var border6 = (color_domain[4] + interval);
    var border7 = (color_domain[5] + interval);
    var border8 = (color_domain[6] + interval);
    var border9 = (color_domain[7] + interval);
    var border10 = (color_domain[8] + interval);
    var border11 = color_domain[9];
    var legend_label = [border1.toFixed(1) + " - " + border2.toFixed(1) + "%",
        border2.toFixed(1) + " - " + border3.toFixed(1) + "%",
        border3.toFixed(1) + " - " + border4.toFixed(1) + "%",
        border4.toFixed(1) + " - " + border5.toFixed(1) + "%",
        border5.toFixed(1) + " - " + border6.toFixed(1) + "%",
        border6.toFixed(1) + " - " + border7.toFixed(1) + "%",
        border7.toFixed(1) + " - " + border8.toFixed(1) + "%",
        border8.toFixed(1) + " - " + border9.toFixed(1) + "%",
        border9.toFixed(1) + " - " + border10.toFixed(1) + "%",
        border10.toFixed(1) + " - " + border11.toFixed(1) + "%"
    ]
    var ls_w = 20,
        ls_h = 20;
    var legend = svg.selectAll("g.legend").remove();

    var legend = svg.selectAll("g.legend")
        .data(ext_color_domain)
        .enter().append("g")
        .attr("class", "legend");

    legend.append("rect")
        .attr("x", width - 100)
        .attr("y", function(d, i) {
            return height / 3 - (i * ls_h) - 2 * ls_h;
        })
        .attr("width", ls_w)
        .attr("height", ls_h)
        .style("fill", function(d, i) {
            return color(d);
        })
        .style("opacity", 0)
        .transition()
        .duration(2500)
        .style("opacity", 1);

    legend.append("text")
        .attr("x", width - 70)
        .attr("y", function(d, i) {
            return height / 3 - (i * ls_h) - ls_h - 4;
        })
        .text(function(d, i) {
            return legend_label[i];
        })
        .style("opacity", 0)
        .transition()
        .duration(2500)
        .style("opacity", 1);

    //Load in GeoJSON data
    d3.json("kommuner.json", function(json) {
        //Merge the ag. data and GeoJSON
        //Loop through once for each ag. data value
        for (var i = 0; i < data.length; i++) {
            //Grab state name
            var dataState = data[i].kommunenavn;
            //console.log(dataState);
            //Grab data value, and convert from string to float
            var dataValue = parseFloat(data[i].kommunenummer);
            //Find the corresponding state inside the GeoJSON
            for (var j = 0; j < json.features.length; j++) {
                var jsonState = json.features[j].properties.KOMNAVN;
                if (dataState == jsonState) {
                    //Copy the data value into the JSON
                    json.features[j].properties.KOMNR = dataValue * 100;
                    //console.log(jsonState);
                    //console.log(json.features[j].properties.KOMNR);
                    //Stop looking through the JSON
                }
            }
        }
        //Bind data and create one path per GeoJSON feature
        d3.selectAll(".province").remove();
        var provinces = svg.selectAll('.province').data(json.features).enter();
        provinces.append('path').attr('class', function(d) {
                return 'province ' + d.properties.KOMNR;
            })
            .attr('d', path)
            .style("fill", function(d) {
                //Get data value
                var value = d.properties.KOMNR;
                if (value) {
                    //If value exists…
                    return color(value);

                } else {
                    //If value is undefined…
                    return "#ccc";
                }
            })

        .on('mousemove', function(d) {
                var mouse = d3.mouse(svg.node()).map(function(d) {
                    return parseInt(d);
                });
                if (d.properties.KOMNR) {
                    tooltip.classed('hidden', false)
                    .style("top", (d3.event.pageY + 16) + "px")
                    .style("left", (d3.event.pageX + 16) + "px")

                        .html(d.properties.KOMNAVN + ': ' + d.properties.KOMNR.toFixed(2) + '%');
                } else {
                    tooltip.classed('hidden', false)
                    .style("top", (d3.event.pageY + 16) + "px")
                    .style("left", (d3.event.pageX + 16) + "px")
                    .html(d.properties.KOMNAVN + ': Ukendt');
                }
                d3.select(this)
                    .style("opacity", 0.5);
            })
            .on('mouseout', function() {
                tooltip.classed('hidden', true);
                d3.select(this)
                    .style("opacity", 1);
            });
    });
});
}

function range(start, stop, step) {
if (typeof stop == 'undefined') {
    // one param defined
    stop = start;
    start = 0;
}
if (typeof step == 'undefined') {
    step = 1;
}
if ((step > 0 && start >= stop) || (step < 0 && start <= stop)) {
    return [];
}
var result = [];
for (var i = start; step > 0 ? i < stop : i > stop; i += step) {
    result.push(i);
}
return result;
};

function plotKNN(filenameKNN) {


    var width = 600,
    height = 800,
    center = [11.9, 56.7]
    scale = 7000,
    opacity = 1;

var projection = d3.geo.mercator().scale(scale).center(center);
var path = d3.geo.path().projection(projection)

d3.select("#map_knn").selectAll("svg").remove();
var svg_knn = d3.select("#map_knn").append("svg").attr("width", width).attr("height", height);

    //Load in GeoJSON data
    d3.json("kommuner.json", function(json) {

        var color_knn = d3.scale.category10();
        var cValue = function(d) {
            return d.dk5;
        }

        var color_domain_knn = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
        var ext_color_domain_knn = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
        var legend_labels = ["Blandet indhold", "Filosofi, psykologi og forskning", "Religion", "Samfundsvidenskab", "Geografi og rejser", "Naturvidenskab og matematik", "Praktiske fag", "Kunst, spil og sport", "Litteratur og sprog", "Historie og biografier"];
        color_knn.domain([0, 9]);

        var provinces_knn = svg_knn.selectAll('.kommune').data(json.features).enter();
        provinces_knn.append('path').attr('class', function(d) {
                return 'kommune ' + d.properties.KOMNR;
            })

            .attr('d', path)
            .style("fill", "Black")

            var legend_knn = svg_knn.selectAll("g.legend")
                .data(ext_color_domain_knn)
                .enter().append("g")
                .attr("class", "legend");

            var ls_w = 20,
                ls_h = 20;

            legend_knn.append("rect")
                .attr("x", width - 185)
                .attr("y", function(d, i) {
                    return height / 3 - (i * ls_h) - 2 * ls_h - 20;
                })
                .attr("width", ls_w)
                .attr("height", ls_h)

            .style("fill", function(d, i) {
                return color_knn(d);
            })

            .style("opacity", opacity)
                .style("stroke", "White")
                .style("stroke-width", 1);

            legend_knn.append("text")
                .attr("x", width - 160)
                .attr("y", function(d, i) {
                    return height / 3 - (i * ls_h) - ls_h - 5 - 20;
                })
                .text(function(d, i) {
                    return legend_labels[i];
                });

        d3.csv(filenameKNN, function(data) {
            svg_knn.selectAll(".rect")
                .data(data)
                .enter()
                .append("rect")
                .attr("x", function(d) {
                    return projection([d.lon, d.lat])[0];
                })
                .attr("y", function(d) {
                    return projection([d.lon, d.lat])[1];
                })

            .style("fill", function(d) {
                return color_knn(cValue(d))

            })
            
            .attr("width", width / 110)
            .attr("height", height / 110)
            .style("opacity", opacity);

        });



    });

}
      
d3.csv("data/fem_top25.csv", function(error, data) {
  d3.csv("data/mal_top25.csv", function(error,data2){
      d3.csv("data/fem_top10_by_age.csv", function(error,data3){
          d3.csv("data/loans_by_month.csv", function(error,data4){
              d3.csv("data/dfrules_clean.csv", function(error,data5){
                  if (error) throw error;
                    dataset = data;
                    dataset2 = data2;
                    dataset3 = data3;
                    dataset4 = data4;
                    dataset5 = data5;
                    dataset_total = data.concat(data2);
                
                  
                    buildBar(dataset);
                    var selector = d3.select("#female");
                    selector.classed("selected", true);
                    
                    buildAgeBar(dataset3);
                    
                    buildMonthBar(dataset4);
                    
                    buildRulesBar(dataset5);
                    d3.select("#map_popularbooks").append("svg").attr("width", 600).attr("height", 800);
                    updateData("kommuneratio/Filosofi.csv");

                    plotKNN("knn/knn50.csv")
                
                    d3.selectAll("p")
                            .on("click", function() {
                            //See which p was clicked
                            var paragraphID = d3.select(this).attr("id");
                            
                            if (paragraphID == "male") {
                              var temp_data = dataset2;
                              updateBar(temp_data);
                              var selector = d3.select("#male");
                              selector.classed("selected", true);
                              var unselector = d3.select("#female");
                              unselector.classed("selected", false);
                            }
                            if (paragraphID == "female") {
                              //Remove a value
                              var temp_data = dataset;
                              updateBar(temp_data);
                              var selector = d3.select("#female");
                              selector.classed("selected", true);
                              var unselector = d3.select("#male");
                              unselector.classed("selected", false);
                            } 
                            
                            if (paragraphID == "g10k") {
                              var selector = d3.select("#g10k");
                              selector.classed("selected", true);
                              var unselector = d3.select("#g100k");
                              unselector.classed("selected", false);
                                var hideme = d3.select("#g100kgraph");
                                hideme.classed("hidden", true);
                                var showme = d3.select("#g10kgraph");
                                showme.classed("hidden", false);
                            } 
                            if (paragraphID == "g100k") {
                              var selector = d3.select("#g100k");
                              selector.classed("selected", true);
                              var unselector = d3.select("#g10k");
                              unselector.classed("selected", false);
                                var hideme = d3.select("#g10kgraph");
                                hideme.classed("hidden", true);
                                var showme = d3.select("#g100kgraph");
                                showme.classed("hidden", false);
                            } 
                        
                            });
                    d3.select("#book").on("change", changebook)
                        function changebook() {
                        var sel = document.getElementById('book');
                        var val = sel.options[sel.selectedIndex].value;
                        updateAgeBar(dataset3, val);
                    }
        
                    d3.select("#year").on("change", changebook2)
                        function changebook2() {
                        var sel = document.getElementById('year');
                        var val = sel.options[sel.selectedIndex].value;
                        updateMonthBar(dataset4, val);
                    }
                    d3.select("#select_popularbooks").on("change", function(a) {
                      var sel = document.getElementById('select_popularbooks');
                      var val = sel.options[sel.selectedIndex].value;
                      var val = String(val);
                      updateData(val);
                  });

                  d3.select("#select_knn").on("change", function(a) {
                    var sel = document.getElementById('select_knn');
                    var val = sel.options[sel.selectedIndex].value;
                    var val = String(val);
                    plotKNN(val);
                  });
              });
            
            });
        });
    
    });

});
</script>


      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/kristiangreve/socialdata">Socialdata</a> is maintained by <a href="https://github.com/kristiangreve">kristiangreve</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </body>

</html>
